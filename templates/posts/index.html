{% extends 'base.html' %}

{% load static %}

{% block title %}Blog{{ block.super }}{% endblock %}

{% block description %}Needs description{% endblock %}

{% block inline_css %}
<style type="text/css">
	.blog-hp-hero-bg {
		background: linear-gradient(135deg, #E75C00c4 0%, #E89000c4 100%), url({% static 'img/DSC_2859.jpg' %});
		background-repeat: no-repeat;
		background-size: cover;
		background-position: center;
		color: #fff;
	}

	.light-gray-arch-bg {
		background-color: #f7f7f7;
	}

	.pag-custom {
		box-shadow: 5px 2px 20px 0 rgba(0,0,0,0.20);
	}

	.pag-custom a {
		color: #919191;
	}

	.pag-custom a:hover {
		background-color: #f7f7f7;
		color: #3a3a3a;
	}

	.pag-custom a:focus {
		box-shadow: none;
	}

	.pag-custom a.active {
		background-color: #f7f7f7;
		color: #3a3a3a;
		pointer-events: none;
  		cursor: default;
	}

	.cat-nav {
		background-color: transparent !important;
	}

	.cat-nav .navbar-toggler {
		border: 0px;
		color: #fff;
	}

	.cat-nav .navbar-toggler:hover,
	.cat-nav .navbar-toggler:focus {
		color: #fff;
	}

	.cat-nav .navbar-toggler i {
		color: #b8b8b8;
	}

	.cat-nav .navbar-nav .nav-link {
		color: #fff;
		font-weight: 500;
	}

	.cat-nav .navbar-nav .nav-link:hover {
		color: #b8b8b8;
	}

	.cat-nav .navbar-nav .nav-link.active {
		color: #d1d1d1;
	}

</style>
{% endblock %}

{% block script %}
<script>

$(document).ready(function(){
	var postList = [];
	var nextPostUrl;
	var prevPostUrl;
	var nextOffsetOnePostUrl;
	var prevOffsetOnePostUrl;

	function parsePosts(){
		if (postList == 0){
			// empty container before displaying message regaring 0 object
			$('#featured-post').empty()
			$('#general-post').empty()
			$('#featured-post').append('<h3 class="text-center py-5">Currently there aren\'t any posts available.</h3>')
		} else {
			var index = 0;
			$('#general-post').empty()
			$.each(postList, function(key, value){
				// set category variable for checking if category exists later
				var postCategory;
				var postTitle = value.post_title
				var postShortTitle = value.shorter_title
				var postPubDate = value.pub_date
				var postContent = value.strip_content
				var postShortContent = value.shorter_content
				// check if category exists otherwise it breaks
				if (value.post_category[0]) {
					postCategory = value.post_category[0].category_name
				} else {
					postCategory = ''
				}
				var postFeatImg = value.feat_img
				var postThumbImg = value.thumb_img
				var postUrl = value.post_url
				index += 1
				if (index == 1) {
					$('#featured-post').html(
						'<div class="card blog-card my-4"><div class="row no-gutters"><div class="col-md-4 rounded blog-img blog-row" style="background-image: url(' + postThumbImg + ');"></div><div class="col-md-8 d-flex align-items-center"><div class="card-body"><span class="small arch-orange">' + postCategory + '</span><i class="fas fa-circle align-middle mx-2"></i><span class="small text-muted">' + postPubDate + '</span><h5 class="card-title">' + postTitle + '</h5><p class="card-text">' + postContent + '</p><div class="row"><div class="col-6"><a href="' + postUrl + '" class="btn btn-outline-primary btn-block arch-btn-outline-primary" role="button" aria-pressed="true">Read More</a></div></div></div></div></div></div>'
					).hide().fadeIn(500);
				} else {
					$('#general-post').append(
						'<div class="col-lg-4 col-md-6 col-12 mb-4 d-flex align-items-stretch"><div class="card blog-card"><div class="card-img-top blog-img blog-row" style="background-image: url(' + postThumbImg + ');"></div><div class="card-body"><span class="small arch-orange">' + postCategory + '</span><i class="fas fa-circle align-middle mx-2"></i><span class="small text-muted">' + postPubDate + '</span><h5 class="card-title">' + postShortTitle + '</h5><p class="card-text">' + postShortContent + '</p><div class="row"><div class="col-6"><a href="' + postUrl + '" class="btn btn-outline-primary btn-block arch-btn-outline-primary" role="button" aria-pressed="true">Read More</a></div></div></div></div></div>'
					).hide().fadeIn(500);
				}

			})

		}
	}

	function buildPagination(){
		// if previous page exists append previous arrow element

		var pagLinks = '';

		console.log(prevPostUrl)
		console.log(nextPostUrl)

		if (prevPostUrl) {
			pagLinks += '<li class="page-item"><a class="page-link" id="pagePrevious" href="#"><i class="fas fa-angle-left"></i></a></li>'
		}

		if (prevPostUrl && !nextPostUrl){
			var prevOffsetOne = prevNumber - 1;
			if (prevOffsetOne > 0){
				pagLinks += '<li class="page-item"><a class="page-link" id="previousOffsetOne" href="#">' + prevOffsetOne + '</a></li><li class="page-item"><a class="page-link" id="pagePrevious" href="#">' + prevNumber + '</a></li><li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li>'
			} else {
				pagLinks += '<li class="page-item"><a class="page-link" id="pagePrevious" href="#">' + prevNumber + '</a></li><li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li>'
			}
		}

		if (prevPostUrl && nextPostUrl){
			var prevOffsetOne = prevNumber - 1;
			var nextOffsetOne = nextNumber + 1;
			if (prevOffsetOne > 0 && nextOffsetOne <= totalPages){
				pagLinks += '<li class="page-item"><a class="page-link" id="previousOffsetOne" href="#">' + prevOffsetOne + '</a></li><li class="page-item"><a class="page-link" id="pagePrevious" href="#">' + prevNumber + '</a></li><li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li><li class="page-item"><a class="page-link" id="pageNext" href="#">' + nextNumber + '</a></li><li class="page-item"><a class="page-link" id="nextOffsetOne" href="#">' + nextOffsetOne + '</a></li>'	
			} else if (prevOffsetOne <= 0 && nextOffsetOne <= totalPages){
				pagLinks += '<li class="page-item"><a class="page-link" id="pagePrevious" href="#">' + prevNumber + '</a></li><li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li><li class="page-item"><a class="page-link" id="pageNext" href="#">' + nextNumber + '</a></li><li class="page-item"><a class="page-link" id="nextOffsetOne" href="#">' + nextOffsetOne + '</a></li>'
			} else if (prevOffsetOne > 0 && nextOffsetOne >= totalPages){
				pagLinks += '<li class="page-item"><a class="page-link" id="previousOffsetOne" href="#">' + prevOffsetOne + '</a></li><li class="page-item"><a class="page-link" id="pagePrevious" href="#">' + prevNumber + '</a></li><li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li><li class="page-item"><a class="page-link" id="pageNext" href="#">' + nextNumber + '</a></li>'
			}
		}

		if (!prevPostUrl && nextPostUrl){
			var nextOffsetOne = nextNumber + 1;
			if (nextOffsetOne <= totalPages){
				pagLinks += '<li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li><li class="page-item"><a class="page-link" id="pageNext" href="#">' + nextNumber + '</a></li><li class="page-item"><a class="page-link" id="nextOffsetOne" href="#">' + nextOffsetOne + '</a></li>'
			} else {
				pagLinks += '<li class="page-item"><a class="page-link active" href="#">' + currentIndex + '</a></li><li class="page-item"><a class="page-link" id="pageNext" href="#">' + nextNumber + '</a></li>'
			}	
		}

		// if next page exists append next arrow element
		if (nextPostUrl) {
			pagLinks += '<li class="page-item"><a class="page-link" id="pageNext" href="#"><i class="fas fa-angle-right"></i></a></li>'
		}

		console.log(pagLinks)

		$('#pagination-list').html(pagLinks).hide().fadeIn(500);
	}

	function fetchPosts(url, cat){
		console.log('fetching...')
		var fetchUrl;
		if (!url) {
			fetchUrl = '/blog/api/list-post/'
		} else if (cat) {
			fetchUrl = url + cat + '/'
		} else {
			fetchUrl = url
		}
		$.ajax({
			url: fetchUrl,
			method: 'GET',
			success: function(data){
				console.log(fetchUrl)
				currentUrl = fetchUrl
				currentIndex = data['prev_page_num'] + 1
				prevNumber = data['prev_page_num']
				prevNumberOffsetOne = prevNumber - 1
				nextNumber = data['nex_page_num']
				nextNumberOffsetOne = nextNumber + 1
				totalPages = data['total_pages']
				postList = data['results']
				if (data.next){
					nextPostUrl = data.next
				} else {
					nextPostUrl = undefined
				}
				if (data.previous){
					prevPostUrl = data.previous
				} else {
					prevPostUrl = undefined
				}

				var allUrl = '/blog/api/list-post/'
				var catUrl = '/blog/api/' + cat + '/'

				// checks which API is being called and connects to correct path
				if (fetchUrl.includes('list-post')){
					if (prevNumberOffsetOne > 0) {
						prevOffsetOnePostUrl = allUrl + '?page=' + prevNumberOffsetOne
					} else {
						prevOffsetOnePostUrl = undefined
					}

					if (nextNumberOffsetOne <= totalPages) {
						nextOffsetOnePostUrl = allUrl + '?page=' + nextNumberOffsetOne
					} else {
						nextOffsetOnePostUrl = undefined
					}
				} else {
					if (prevNumberOffsetOne > 0) {
						prevOffsetOnePostUrl = catUrl + '?page=' + prevNumberOffsetOne
					} else {
						prevOffsetOnePostUrl = undefined
					}

					if (nextNumberOffsetOne <= totalPages) {
						nextOffsetOnePostUrl = catUrl + '?page=' + nextNumberOffsetOne
					} else {
						nextOffsetOnePostUrl = undefined
					}
				}
				
				parsePosts()
				// checks number of pages
				if (totalPages > 1){
					buildPagination()
				} else {
					// need to remove pagination 
					$('#pagination-list').empty()
				}
			},
			error: function(data){
				console.log('error')
				console.log(data)
			}
		})
	}

	fetchPosts();

	$(document).on('click', '#pagePrevious', function(event){
		event.preventDefault()
		console.log('tester')
		if (prevPostUrl){
			fetchPosts(prevPostUrl)
		}
	})

	$(document).on('click', '#pageNext', function(event){
		event.preventDefault()
		console.log('tester')
		if (nextPostUrl){
			fetchPosts(nextPostUrl)
		}
	})

	$(document).on('click', '#nextOffsetOne', function(event){
		event.preventDefault()
		console.log('tester')
		if (nextOffsetOnePostUrl){
			fetchPosts(nextOffsetOnePostUrl)
		}
	})

	$(document).on('click', '#previousOffsetOne', function(event){
		event.preventDefault()
		console.log('tester')
		if (prevOffsetOnePostUrl){
			fetchPosts(prevOffsetOnePostUrl)
		}
	})

	$(document).on('click', '#allPosts', function(event){
		event.preventDefault()
		$('#categoryH1').empty()
		fetchPosts()
	})

	$(document).on('click', '#categoryName', function(event){
		event.preventDefault()
		var catSlug = $(this).attr('name');
		var catName = $(this).text();
		fetchPosts('/blog/api/', catSlug)
		$('#categoryH1').empty()
		$('#categoryH1').append('<div class="col-12 mt-4"><h3 class="text-muted">' + catName + '</h3><div class="row ml-0"><div class="col-lg-1 col-md-2 col-3 arch-underline"></div></div></div>')
	})

	// add active class to category nav links on click
	$(document).on('click', '.cat-nav.nav-link', function() {
		$(this).parent().find('.cat-nav.nav-link.active').removeClass('active');
		$(this).addClass('active');
	});

	$(document).on('click', '.cat-nav .navbar-toggler', function() {
		$('#flipOver').toggleClass('fa-rotate-180');
	});
});
	
</script>
{% endblock %}

{% block social_data %}{% endblock %}

{% block schema_data %}{% endblock %}

{% block content %}
<div class="blog-hp-hero-bg">
	<div class="container">
		<div class="row py-5">
			<div class="col-lg-6 col-md-8">
				<h1 class="text-white pt-5">Arch Value Blog &amp; Resources</h1>
				<p class="text-white">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
			</div>
		</div>
		{% comment %}
		<div class="row">
			<div class="col-12">
				<ul class="list-inline">
						<li class="list-inline-item"><a href="#" id="allPosts">All</a></li>
					{% for category in categories %}
						<li class="list-inline-item"><a href="#" id="categoryName" name="{{ category.category_slug }}">{{ category.category_name }}</a></li>
					{% endfor %}
				</ul>
			</div>
		</div>
		{% endcomment %}
		<nav class="navbar navbar-expand-lg navbar-light bg-light cat-nav">
		  <a class="navbar-brand navbar-toggler pl-0" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation" href="#">Categories <i class="fas fa-angle-down" id="flipOver"></i></a>
		  <!-- <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
		    <span class="navbar-toggler-icon"></span>
		  </button> -->
		  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
		    <div class="navbar-nav">
		    	<a class="nav-item nav-link active" id="allPosts" href="#">All</a>
		    	{% for category in categories %}
		    		<a class="nav-item nav-link" id="categoryName" name="{{ category.category_slug }}" href="#">{{ category.category_name }}</a>
		    	{% endfor %}
		    </div>
		  </div>
		</nav>
		<!-- tester -->
	</div>
</div>
<div class="light-gray-arch-bg">
	<div class="container">
		<div class="row" id="categoryH1">
			
		</div>
		<div class="row justify-content-center">
			<div id="featured-post" class="col-12">
			</div>
		</div>
		<div class="row" id="general-post">
		</div>
		<div class="row justify-content-center">
			<nav aria-label="Page navigation example">
			  <ul class="pagination pag-custom pb-0" id="pagination-list">
			  	<!-- jquery appends pagination -->
			  </ul>
			</nav>
		</div>
	</div>
</div>
{% endblock %}